
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>AdminLTE 2 | Top Navigation</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="./public/lib/bootstrap/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->

  <link rel="stylesheet" href="./public/css/AdminLTE.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="./public/css/skins/_all-skins.min.css">
  <link rel="stylesheet" href="./public/lib/datatables/media/css/jquery.dataTables.min.css">
  <link type="text/css" rel="stylesheet" href="./public/lib/qtip2/jquery.qtip.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
<style>
.myCustomClass{
    border-color: rgb(0,190,0);
    background-color: #ddd;
    width: 250px;
    height: 250px;
}
.myCustomClass .qtip-content{
    font-size: 12px;
}
</style>
</head>
<!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
<body class="hold-transition skin-blue layout-top-nav">
<div class="wrapper">

  <header class="main-header">
    <nav class="navbar navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <a href="../../index2.html" class="navbar-brand">Overview</a>
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
            <i class="fa fa-bars"></i>
          </button>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
          <ul class="nav navbar-nav">

            <li><a href="#">Home</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
        <!-- Navbar Right Menu -->
        <!-- /.navbar-custom-menu -->
      </div>
      <!-- /.container-fluid -->
    </nav>
    <script>
// Popup window code
function newPopup(url) {
  popupWindow = window.open(
    url,'popUpWindow','height=800,width=1000,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes')
}
</script>
  </header>
  <!-- Full Width Column -->
  <div class="content-wrapper">
    <div class="container" ng-app='stock' ng-controller='stockCtrl'>
      <!-- Content Header (Page header) -->
      <section class="content">

      <div class= "row">
        <div class="col-md-12">

                                          <div class="box box-info">
                                            <div class="box-header with-border">
                                              <h3 class="box-title" id = "cveTotal"></h3>
                                            </div><!-- /.box-header -->
                                            <div class="box-body">
                                              <table id="example" class="table table-bordered display">
                                                <thead>
                                                  <tr>

                                                    <th>Code</th>
                                                    <th>Name</th>
                                                    <th>Date</th>
                                                    <th>Open</th>
                                                    <th>Close</th>
                                                    <th>5 Days HHigh</th>
                                                    <th>5 Days LLow</th>
                                                    <th>Rate/Open to HHigh</th>
                                                    <th>Rate/Open to Close</th>
                                                    <th>Rate/LLow to HHigh</th>
                                                    <th>Detail</th>
                                                  </tr>
                                                </thead>
                                              </table>
                                            </div>
                                          </div>



      </div>

    <!-- /.container -->
  </div>
  <!-- /.content-wrapper -->
    </section>

</div>


<!-- jQuery 2.1.4 -->
<script src="./public/lib/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.5 -->
<script src="./public/lib/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="./public/lib/angular/angular.min.js"></script>
<script src="./public/lib/angular-animate/angular-animate.min.js"></script>

<script src="./public/lib/angular-ui-router/release/angular-ui-router.js"></script>

<script src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<script src="./public/lib/angular-datatables/dist/angular-datatables.min.js"></script>
<script src="./public/lib/datatables.net-select/js/dataTables.select.min.js"></script>
<script src="./public/lib/underscore/underscore-min.js"></script>
<script src="./public/lib/qtip2/jquery.qtip.js"></script>
<script src="./public/lib/highcharts/highstock.js"></script>
<script src="./public/lib/highcharts//js/modules/exporting.js"></script>
<!-- AdminLTE App -->
<script src="./public/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="./public/js/demo.js"></script>

<script>


  var stock = angular.module('stock',[]);
    stock.controller('stockCtrl', function($scope,$http){
       $http.get('./back/selectStocks.php').then(function(data){
          var data = data.data.data;

          data = _.groupBy(data,'ID');
          data = _.map(data,function(arr,index){
              return [arr][0];
          });

      var dataset = _.map(data,function(arr,index){
        
            return {
              id : arr[0].ID,
              code : arr[0].Code,
              name : arr[0].Name,
              date : arr[0].Enter_Date,
              origin : arr,
              open : getOpen(arr),
              close : getClose(arr),
              hh : getHHigh(arr),
              ll : getLLow(arr),
              o_hh : ((getHHigh(arr)-getOpen(arr))/getOpen(arr)* 100).toFixed(2)+"%",
              o_c : ((getClose(arr)-getOpen(arr))/getOpen(arr)* 100).toFixed(2)+"%",
              ll_hh : ((getHHigh(arr)-getLLow(arr))/getOpen(arr)* 100).toFixed(2)+"%",
            };
          });
          console.log(dataset);
           var table = $('#example').DataTable({
             data: dataset,
             //bPaginate: false,
             fixedColumns: true,
             order: [[ 2, "desc" ]],
              "pagingType": "full_numbers",
             columns: [

              { "data": "code"},
              { "data": "name"},
              { "data": "date"},
              { "data": "open"},
              { "data": "close"},
              { "data": "hh"},
              { "data": "ll"},
              { "data": "o_hh"},
              { "data": "o_c","fnCreatedCell":function (nTd, sData, oData, iRow, iCol) {

                var da = [];
                var ohlc = [];
                for (var i=0; i < oData.origin.length; i += 1) {
                  da.push(oData.origin[i].After_Date);
           ohlc.push([

               parseFloat(oData.origin[i].Open), // open
               parseFloat(oData.origin[i].High), // high
               parseFloat(oData.origin[i].Low), // low
               parseFloat(oData.origin[i].Close) // close
              ]);

            }
                $(nTd).qtip({ // Grab some elements to apply the tooltip to
                  style: { classes: 'myCustomClass'

                         },
                content: {
                  text : function(event,api){
                    Highcharts.stockChart('qtip-'+iRow, {
                      title: {
                          text: oData.code + "  "+oData.name
                      },

                xAxis: {
                tickPositions: ["day1","day2","day2","day2","day2","day2"]},
                rangeSelector:{
                  enabled:false
                },
                      series: [{
               type: 'candlestick',
               name: oData.name,
               data: ohlc
           }]
                    });
                  }
                }

               });
             }
              },
              { "data": "ll_hh"},

              {"data":"id","fnCreatedCell":function (nTd, sData, oData, iRow, iCol) {
                var url = "JavaScript:newPopup('detail.html?id="+oData.id+"');";
                $(nTd).html("<a href="+url+">Detail</a>");
                }
              },
              {
                "data":"origin"
              }
            ],
            "columnDefs": [
            {
                "targets": [ 11 ],
                "visible": false,
                "searchable": false
            }
        ]
          });
       });


      function getOpen(arr){
        return arr[0].Open;
      }

      function getClose(arr){
        return arr[arr.length-1].Close;
      }

      function getHHigh(arr){
        var high = 0;
        arr.forEach(function(ele){
          if(ele.High > high){
            high = ele.High;
          }
        });
        return high;
      }

      function getLLow(arr){
        var low = 1000;
        arr.forEach(function(ele){
          if(ele.Low < low ){
            low = ele.Low;
          }
        });
        return low;
      }

      $scope.add = function(){
        var code = $("#code").val();
          if(code.charAt(0) == "6"){
            code = "sh"+code
          }else{
            code = "sz"+code
          }
          url = "http://hq.sinajs.cn/list="+code
          console.log(url);

        $http({
          url : "http://hq.sinajs.cn/list=sz300312",
          headers: {
            'Access-Control-Allow-Origin':'*',
      'Accept': 'application/json',
      'X-Login-Ajax-call': 'true'
          }
        }).then(function(data){
          console.log(data);
        });
      }
    });
</script>
</body>
</html>
